const ethusd = {
    bid: [
        {
            quantity: 0.00431681,
            rate: 3470.038,
        },
        {
            quantity: 0.31222387,
            rate: 3467.439,
        },
        {
            quantity: 0.0018034,
            rate: 3467.438,
        },
        {
            quantity: 1.19,
            rate: 3463.07,
        },
        {
            quantity: 0.01999696,
            rate: 3463.069,
        },
        {
            quantity: 3.51,
            rate: 3462.183,
        },
        {
            quantity: 0.01618554,
            rate: 3462.182,
        },
        {
            quantity: 0.043,
            rate: 3462.104,
        },
        {
            quantity: 12.06,
            rate: 3455.412,
        },
        {
            quantity: 0.00388934,
            rate: 3455.411,
        },
        {
            quantity: 0.0051,
            rate: 3455.0,
        },
        {
            quantity: 0.01447411,
            rate: 3454.443,
        },
        {
            quantity: 5.37675694,
            rate: 3450.0,
        },
        {
            quantity: 120.25,
            rate: 3446.959,
        },
        {
            quantity: 0.01618554,
            rate: 3445.515,
        },
        {
            quantity: 0.00181521,
            rate: 3444.889,
        },
        {
            quantity: 0.00183977,
            rate: 3440.509,
        },
        {
            quantity: 0.00512,
            rate: 3438.0,
        },
        {
            quantity: 13.80749478,
            rate: 3433.551,
        },
        {
            quantity: 47.25,
            rate: 3433.55,
        },
        {
            quantity: 0.00927701,
            rate: 3432.0,
        },
        {
            quantity: 0.00652305,
            rate: 3431.43,
        },
        {
            quantity: 0.00391821,
            rate: 3429.948,
        },
        {
            quantity: 0.00728058,
            rate: 3429.0,
        },
        {
            quantity: 0.01618554,
            rate: 3428.928,
        },
    ],
    ask: [
        {
            quantity: 0.86347662,
            rate: 3472.877,
        },
        {
            quantity: 0.86364352,
            rate: 3472.903,
        },
        {
            quantity: 0.9942,
            rate: 3473.05,
        },
        {
            quantity: 0.86347662,
            rate: 3473.224,
        },
        {
            quantity: 1.21431632,
            rate: 3473.466,
        },
        {
            quantity: 1.43940587,
            rate: 3473.596,
        },
        {
            quantity: 0.292,
            rate: 3474.479,
        },
        {
            quantity: 1.43904075,
            rate: 3474.48,
        },
        {
            quantity: 3.06122607,
            rate: 3476.236,
        },
        {
            quantity: 0.43181621,
            rate: 3476.237,
        },
        {
            quantity: 0.425,
            rate: 3477.041,
        },
        {
            quantity: 0.8461,
            rate: 3477.046,
        },
        {
            quantity: 25.96954405,
            rate: 3477.096,
        },
        {
            quantity: 14.60249473,
            rate: 3489.974,
        },
        {
            quantity: 5.68265716,
            rate: 3490.025,
        },
        {
            quantity: 12.06,
            rate: 3490.867,
        },
        {
            quantity: 4.7,
            rate: 3490.875,
        },
        {
            quantity: 8.62424645,
            rate: 3493.844,
        },
        {
            quantity: 5.61804844,
            rate: 3501.116,
        },
        {
            quantity: 0.04640344,
            rate: 3502.173,
        },
        {
            quantity: 33.98054923,
            rate: 3511.847,
        },
        {
            quantity: 117.77,
            rate: 3511.848,
        },
        {
            quantity: 0.12178513,
            rate: 3516.538,
        },
        {
            quantity: 9.03288233,
            rate: 3528.294,
        },
        {
            quantity: 46.85,
            rate: 3535.524,
        },
    ],
}

const btcusd = {
    bid: [
        {
            quantity: 0.00029729,
            rate: 45023.435,
        },
        {
            quantity: 0.49993168,
            rate: 44980.61,
        },
        {
            quantity: 0.074,
            rate: 44980.601,
        },
        {
            quantity: 0.000218,
            rate: 44980.596,
        },
        {
            quantity: 0.0002,
            rate: 44944.04,
        },
        {
            quantity: 0.2197,
            rate: 44920.001,
        },
        {
            quantity: 0.7298,
            rate: 44900.001,
        },
        {
            quantity: 0.01112471,
            rate: 44900.0,
        },
        {
            quantity: 0.002,
            rate: 44899.01,
        },
        {
            quantity: 0.71491797,
            rate: 44880.0,
        },
        {
            quantity: 0.00016087,
            rate: 44847.106,
        },
        {
            quantity: 0.71458623,
            rate: 44840.0,
        },
        {
            quantity: 0.007091,
            rate: 44809.67,
        },
        {
            quantity: 0.71458623,
            rate: 44800.0,
        },
        {
            quantity: 7.2689,
            rate: 44796.652,
        },
        {
            quantity: 0.00070774,
            rate: 44760.0,
        },
        {
            quantity: 3.0385,
            rate: 44619.414,
        },
        {
            quantity: 0.00204219,
            rate: 44610.991,
        },
        {
            quantity: 0.00116172,
            rate: 44595.041,
        },
        {
            quantity: 0.0223516,
            rate: 44583.492,
        },
        {
            quantity: 0.00109611,
            rate: 44581.692,
        },
        {
            quantity: 0.00052484,
            rate: 44580.0,
        },
        {
            quantity: 0.0111842,
            rate: 44550.0,
        },
        {
            quantity: 0.01688071,
            rate: 44547.525,
        },
        {
            quantity: 0.0001635,
            rate: 44520.223,
        },
    ],
    ask: [
        {
            quantity: 0.0585,
            rate: 45057.558,
        },
        {
            quantity: 0.01544706,
            rate: 45057.56,
        },
        {
            quantity: 0.00517123,
            rate: 45057.57,
        },
        {
            quantity: 0.1668,
            rate: 45064.731,
        },
        {
            quantity: 0.06655124,
            rate: 45076.035,
        },
        {
            quantity: 0.06655013,
            rate: 45080.717,
        },
        {
            quantity: 0.53968,
            rate: 45083.799,
        },
        {
            quantity: 0.06654595,
            rate: 45084.327,
        },
        {
            quantity: 0.11092055,
            rate: 45088.186,
        },
        {
            quantity: 0.5409,
            rate: 45093.524,
        },
        {
            quantity: 0.11091665,
            rate: 45099.252,
        },
        {
            quantity: 0.00100156,
            rate: 45100.0,
        },
        {
            quantity: 0.01,
            rate: 45104.174,
        },
        {
            quantity: 2.92330778,
            rate: 45104.177,
        },
        {
            quantity: 0.074,
            rate: 45150.33,
        },
        {
            quantity: 0.47154823,
            rate: 45150.331,
        },
        {
            quantity: 0.44197025,
            rate: 45150.335,
        },
        {
            quantity: 0.2197,
            rate: 45150.336,
        },
        {
            quantity: 0.7298,
            rate: 45184.133,
        },
        {
            quantity: 0.71458623,
            rate: 45200.0,
        },
        {
            quantity: 0.71458623,
            rate: 45240.0,
        },
        {
            quantity: 1.00949312,
            rate: 45279.999,
        },
        {
            quantity: 0.71458623,
            rate: 45280.0,
        },
        {
            quantity: 0.04119831,
            rate: 45293.038,
        },
        {
            quantity: 0.00022753,
            rate: 45300.0,
        },
    ],
}

const ltcusd = {
    bid: [
        {
            quantity: 14.25,
            rate: 287.056,
        },
        {
            quantity: 0.859,
            rate: 287.055,
        },
        {
            quantity: 9.34937449,
            rate: 287.053,
        },
        {
            quantity: 2.0,
            rate: 287.052,
        },
        {
            quantity: 1.63795848,
            rate: 287.048,
        },
        {
            quantity: 0.83139524,
            rate: 287.046,
        },
        {
            quantity: 5.1,
            rate: 287.023,
        },
        {
            quantity: 0.31074739,
            rate: 287.022,
        },
        {
            quantity: 1.7,
            rate: 286.984,
        },
        {
            quantity: 17.6,
            rate: 285.66,
        },
        {
            quantity: 0.6770446,
            rate: 285.659,
        },
        {
            quantity: 0.61274758,
            rate: 285.641,
        },
        {
            quantity: 166.85333198,
            rate: 285.146,
        },
        {
            quantity: 2.17,
            rate: 285.145,
        },
        {
            quantity: 173.0,
            rate: 285.141,
        },
        {
            quantity: 0.35365441,
            rate: 285.0,
        },
        {
            quantity: 0.08080536,
            rate: 283.8,
        },
        {
            quantity: 0.0172,
            rate: 283.787,
        },
        {
            quantity: 69.2,
            rate: 283.672,
        },
        {
            quantity: 0.08688576,
            rate: 283.4,
        },
        {
            quantity: 0.05317866,
            rate: 282.068,
        },
        {
            quantity: 0.09807658,
            rate: 281.6,
        },
        {
            quantity: 35.0,
            rate: 281.393,
        },
        {
            quantity: 17.3,
            rate: 281.058,
        },
        {
            quantity: 0.03320943,
            rate: 280.247,
        },
    ],
    ask: [
        {
            quantity: 0.17707,
            rate: 288.807,
        },
        {
            quantity: 17.32317264,
            rate: 288.857,
        },
        {
            quantity: 17.31599305,
            rate: 288.986,
        },
        {
            quantity: 17.31375861,
            rate: 289.041,
        },
        {
            quantity: 48.46538814,
            rate: 289.241,
        },
        {
            quantity: 42.1036878,
            rate: 289.242,
        },
        {
            quantity: 1.7,
            rate: 289.243,
        },
        {
            quantity: 5.1,
            rate: 289.683,
        },
        {
            quantity: 0.54963373,
            rate: 289.684,
        },
        {
            quantity: 17.6,
            rate: 289.999,
        },
        {
            quantity: 0.47237013,
            rate: 290.0,
        },
        {
            quantity: 0.05227938,
            rate: 290.562,
        },
        {
            quantity: 71.1,
            rate: 290.98,
        },
        {
            quantity: 464.59903444,
            rate: 290.981,
        },
        {
            quantity: 0.03453695,
            rate: 291.0,
        },
        {
            quantity: 57.57268273,
            rate: 291.429,
        },
        {
            quantity: 0.19824133,
            rate: 291.43,
        },
        {
            quantity: 0.02290979,
            rate: 291.809,
        },
        {
            quantity: 0.05209129,
            rate: 291.859,
        },
        {
            quantity: 0.0173,
            rate: 292.251,
        },
        {
            quantity: 0.03464307,
            rate: 292.626,
        },
        {
            quantity: 33.9,
            rate: 292.976,
        },
        {
            quantity: 0.0233088,
            rate: 292.988,
        },
        {
            quantity: 0.02021295,
            rate: 293.737,
        },
        {
            quantity: 0.79916821,
            rate: 293.878,
        },
    ],
}

const portfolio = {
    btc: 0.123,
    eth: 12.2,
    bat: 123,
    ltc: 11.23,
}

const data = {
    ethusd,
    btcusd,
    ltcusd,
}

const findMatchingOffers = (
    assetValue: number,
    data: { bid: any; ask: any }
) => {
    let currentAssetValue = assetValue
    const matchingOffers = []
    while (currentAssetValue > 0) {
        const maxMatchingOffer = { quantity: 0, rate: 0 }
        for (const bid of data.bid) {
            console.log(currentAssetValue)
            if (bid.quantity <= currentAssetValue) {
                console.log(
                    `Odejmuje od ${currentAssetValue} - ${bid.quantity}`
                )
                currentAssetValue -= bid.quantity
            }
        }
        if (currentAssetValue != 0) break
    }
}

const sumValues = (values: number[]) => values.reduce((a, b) => a + b, 0)

const closestValue = (values: number[], goal: number) =>
    values.reduce((prev, curr) =>
        Math.abs(curr - goal) < Math.abs(prev - goal) ? curr : prev
    )
/*

Przekazujemy wszystkie dostępne kursy w ramach danego rynku np. BTC-USD
oraz liczbę n = ilość zasobu

Sparowujemy ilosc zasobu z ofertami kursów, tak zeby wyprzedac cala ilosc zasobu.
Jesi sie uda - sukces.
Jesli sie nie uda, to dopasowujemy do ofert, za ktore sprzedamy
jak najwiecej sie da z tego co mamy.

A resztkę wrzucamy na rynek (ask) i chcemy sprzedac, wiec bedziemy czekac az ktos kupi.
Do tego dochodzi fee makerFee.

*/
// [sum items, sum]
// this is definitely good
const checkSum = (numbers: number[], n: number, numberOfAttempts: number) => {
    const sums: Array<[number[], number]> = []
    for (let i = 0; i < numbers.length; i++) {
        const value = numbers[i]
        console.log(value)
        if (value === n) return [[value], n]

        const sumsCopy = sums.slice()
        for (let j = 0; j < sumsCopy.length; j++) {
            if (j > numberOfAttempts) break
            const item = sumsCopy[j]
            const sumItems = [...item[0], value]
            const sum = sumValues(sumItems)

            if (sum == n) {
                return [sumItems, sum]
            } else if (sum < n) sums.push([sumItems, sum])
        }
        sums.push([[value], value])
    }

    // didn't find the ideal offer matches
    // pick the closest offer to the volume

    // no need to further look for the closest value
    // if the precision is satisfied (for instance 1.1291 is close enough to 1.13)
    const maxPrecision = 4
    let closest = numbers[0]
    let chosenIndex = 0
    for (let i = 0; i < sums.length; i++) {
        const sumValue = sums[i][1]
        if (Math.abs(sumValue - n) < Math.abs(closest - n)) {
            closest = sumValue
            chosenIndex = i

            if (n - closest <= Math.pow(10, -maxPrecision)) {
                console.log('TEST', n - closest)
                break
            }
        }
    }
    console.log(n, closest, chosenIndex, sums[chosenIndex])

    const leftOver = n - closest
    // now we need to find the best offer for the leftover that didnt fit the initial matches
    const leftOverClosest = closestValue(numbers, leftOver)
    // find this offer and its rate
    console.log(leftOver, leftOverClosest)

    const fittingQuantities = sums[chosenIndex]

    // return sums

    return [sums[chosenIndex], n]
}
const numbers = data.ethusd.bid.map((item) => item.quantity)

// const goal = 0.07471529;
const goal = portfolio.eth
const numberOfAttempts = 1000
console.log(checkSum(numbers, goal, numberOfAttempts))
// console.log(checkSum([21, 34, 51, 2, 41, 3, 9], 50, numberOfAttempts))
// [([41, 9], 50)]

// findMatchingOffers(portfolio.btc, data.btcusd)
